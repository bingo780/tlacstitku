<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Skener: Windows + iOS Fix</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #eef2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        #main-container {
            width: 100%; max-width: 600px; margin: 10px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* KARTY */
        .card {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }

        /* VSTUPY */
        .usb-input {
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ccc; border-radius: 8px;
            text-align: center; background: #f9f9f9; box-sizing: border-box;
        }

        /* KAMERA A FOTENIE */
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        
        .btn {
            width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px;
            cursor: pointer; color: white; font-weight: bold; margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-cam { background: #007bff; }
        .btn-file { background: #6610f2; } /* Fialov√° pre fotenie */
        .btn-stop { background: #dc3545; display: none; }
        .btn-print { background: #28a745; font-size: 18px; margin-top: 20px; }

        /* SKRYT√ù INPUT PRE FOTKU */
        #qr-input-file { display: none; }

        /* FORMUL√ÅR */
        .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .full { grid-column: span 2; }
        .grid-form input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }

        /* CHYBY */
        #error-msg { color: #dc3545; background: #ffe6e6; padding: 10px; border-radius: 5px; font-size: 13px; display: none; margin-top: 5px; }

        /* TLAƒå */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            #main-container { display: none; }
            .page-container { display: block !important; margin: 0 !important; box-shadow: none !important; }
        }

        .page-container {
            width: 210mm; height: 297mm; background: white;
            padding: 10mm; box-sizing: border-box; display: block; overflow: hidden; margin-bottom: 50px;
        }
        .label-grid { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(13, 1fr); width: 100%; height: 100%; }
        .label { box-sizing: border-box; padding: 2px 4px; font-size: 9pt; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .row-surname { font-weight: 900; text-transform: uppercase; font-size: 11pt; white-space: nowrap; overflow: hidden; }
        .row-name-kvl { display: flex; justify-content: space-between; }
        .row-rc { font-family: 'Courier New', monospace; letter-spacing: -0.5px; font-weight: bold; }
        .row-poi-diag { display: flex; justify-content: space-between; align-items: flex-end; font-weight: bold; }
        .diag-code { background: black; color: white; padding: 1px 4px; font-size: 9pt; }
    </style>
</head>
<body>

<div id="main-container">
    
    <div class="card">
        <h2>1. Naƒç√≠tanie k√≥du</h2>
        
        <label style="font-size:14px; font-weight:bold;">A) Windows (USB Skener):</label>
        <input type="text" id="usbInput" class="usb-input" placeholder="Klikni a p√≠pni..." autocomplete="off">
        
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

        <label style="font-size:14px; font-weight:bold;">B) Mobil (Kamera / Fotka):</label>
        <div id="error-msg"></div>
        
        <button id="btn-start" class="btn btn-cam" onclick="startCamera()">üì∑ Spusti≈• ≈æiv√∫ kameru</button>
        <button id="btn-stop" class="btn btn-stop" onclick="stopCamera()">‚ùå Zavrie≈• kameru</button>
        
        <label for="qr-input-file" class="btn btn-file">üìÅ Odfoti≈• QR k√≥d (Istota)</label>
        <input type="file" id="qr-input-file" accept="image/*" capture="environment">

        <div id="qr-reader"></div>
    </div>

    <div class="card">
        <h2>2. √ödaje na ≈°t√≠tok</h2>
        <div class="grid-form">
            <input type="text" id="dataSurname" placeholder="PRIEZVISKO" class="full">
            <input type="text" id="dataName" placeholder="Meno" class="full">
            <input type="text" id="dataRC" placeholder="Rodn√© ƒç√≠slo">
            <input type="text" id="dataPoi" placeholder="Pois≈•ov≈àa">
            <input type="text" id="dataDiag" placeholder="Diagn√≥za">
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center;">
            <label>Odsun: <input type="number" id="offsetInput" value="0" style="width:40px"></label>
            <label>Poƒçet: <input type="number" id="countInput" value="10" style="width:40px"></label>
            <button onclick="updatePreview()" style="padding:8px;">üîÑ OK</button>
        </div>
    </div>

    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Tlaƒçi≈•</button>
</div>

<div class="page-container">
    <div class="label-grid" id="gridContainer"></div>
</div>

<script>
    // --- LOGIKA ---
    function processCode(text) {
        if (!text) return;
        text = text.trim();
        const parts = text.split('|');
        if (parts.length >= 5) {
            document.getElementById('dataSurname').value = parts[0];
            document.getElementById('dataName').value = parts[1];
            document.getElementById('dataRC').value = parts[2];
            document.getElementById('dataPoi').value = parts[3];
            document.getElementById('dataDiag').value = parts[4];
            
            updatePreview();
            alert("‚úÖ Naƒç√≠tan√©: " + parts[0]);
            return true;
        } else {
            alert("‚ö†Ô∏è Chybn√Ω form√°t QR k√≥du!");
            return false;
        }
    }

    // --- 1. USB SKENER ---
    const usbInput = document.getElementById('usbInput');
    usbInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (processCode(this.value)) this.value = "";
        }
    });

    // --- 2. FOTENIE S√öBORU (iPhone FIX) ---
    const fileInput = document.getElementById('qr-input-file');
    const html5QrCode = new Html5Qrcode("qr-reader");

    fileInput.addEventListener('change', e => {
        if (e.target.files.length == 0) return;
        const imageFile = e.target.files[0];
        
        // Skenovanie zo s√∫boru/fotky
        html5QrCode.scanFile(imageFile, true)
        .then(decodedText => {
            processCode(decodedText);
        })
        .catch(err => {
            alert("‚ùå QR k√≥d sa nena≈°iel na fotke. Sk√∫ste odfoti≈• bli≈æ≈°ie a ostrej≈°ie.");
        });
    });

    // --- 3. ≈ΩIV√Å KAMERA ---
    function startCamera() {
        document.getElementById('error-msg').style.display = 'none';
        document.getElementById('btn-start').style.display = "none";
        document.getElementById('btn-stop').style.display = "flex";
        
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                processCode(decodedText);
                stopCamera();
            },
            (errorMessage) => { /* ignorujeme chyby pri hƒæadan√≠ */ }
        ).catch(err => {
            document.getElementById('error-msg').innerText = "Chyba kamery: " + err;
            document.getElementById('error-msg').style.display = 'block';
            stopCamera();
        });
    }

    function stopCamera() {
        html5QrCode.stop().then(() => {
            document.getElementById('qr-reader').innerHTML = "";
        }).catch(err => {}).finally(() => {
            document.getElementById('btn-start').style.display = "flex";
            document.getElementById('btn-stop').style.display = "none";
        });
    }

    // --- PREKRESLENIE ---
    function updatePreview() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = ''; 
        const offset = parseInt(document.getElementById('offsetInput').value) || 0;
        const count = parseInt(document.getElementById('countInput').value) || 1;
        
        const data = {
            surname: document.getElementById('dataSurname').value || "PRIEZVISKO",
            name: document.getElementById('dataName').value || "Meno",
            rc: document.getElementById('dataRC').value || "000000/0000",
            poi: document.getElementById('dataPoi').value || "0000",
            diag: document.getElementById('dataDiag').value || "X00.0",
            kvl: "KVL1-KJ"
        };

        for (let i = 0; i < offset; i++) grid.appendChild(document.createElement('div'));
        for (let i = 0; i < count; i++) {
            const label = document.createElement('div');
            label.className = 'label';
            label.innerHTML = `
                <div class="row-surname">${data.surname}</div>
                <div class="row-name-kvl"><span>${data.name}</span><span style="font-size:7pt;">${data.kvl}</span></div>
                <div class="row-rc">RC: ${data.rc}</div>
                <div class="row-poi-diag"><span>Poi: ${data.poi}</span><span class="diag-code">${data.diag}</span></div>`;
            grid.appendChild(label);
        }
    }
    window.onload = updatePreview;
</script>
</body>
</html>
