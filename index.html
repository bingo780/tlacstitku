<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inteligentn√° Tlaƒç ≈†t√≠tkov (OCR)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f2f2f7; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* OVL√ÅDAC√ç PANEL */
        #controls {
            background: white; padding: 20px; margin: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 12px;
            width: 95%; max-width: 600px;
        }

        h2 { margin-top: 0; font-size: 1.1rem; text-align: center; color: #333; }

        /* Tlaƒçidl√° a Inputs */
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        
        /* Skryt√Ω input pre s√∫bor */
        #cameraInput { display: none; }

        .btn-photo {
            background-color: #007AFF; color: white;
            padding: 15px; border-radius: 10px; border: none;
            font-size: 18px; font-weight: bold; cursor: pointer;
            text-align: center; display: block; width: 100%; box-sizing: border-box;
        }
        
        .btn-print {
            background-color: #34C759; color: white;
            padding: 12px; border-radius: 8px; border: none;
            font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;
        }

        .inputs-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
        }
        input {
            padding: 10px; border: 1px solid #c7c7cc; border-radius: 8px;
            font-size: 16px; width: 100%; box-sizing: border-box;
        }
        .full-width { grid-column: span 2; }

        /* Loading stav */
        #statusMessage {
            text-align: center; color: #666; font-size: 0.9rem; margin: 10px 0; font-style: italic; min-height: 20px;
        }

        /* --- TLAƒå (A4) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            #controls { display: none; }
            .page-container { box-shadow: none !important; margin: 0 !important; }
        }

        .page-container {
            width: 210mm; height: 297mm; background: white;
            padding: 10mm; box-sizing: border-box;
            /* box-shadow: 0 0 10px rgba(0,0,0,0.2); */
            overflow: hidden;
        }

        .label-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(13, 1fr);
            width: 100%; height: 100%;
        }

        .label {
            padding: 2px 4px; box-sizing: border-box;
            font-size: 9pt; display: flex; flex-direction: column;
            justify-content: space-between; overflow: hidden;
        }

        .row-surname { font-weight: 900; text-transform: uppercase; font-size: 11pt; white-space: nowrap; overflow: hidden; }
        .row-name-kvl { display: flex; justify-content: space-between; }
        .row-rc { font-family: 'Courier New', monospace; letter-spacing: -0.5px; font-weight: bold; }
        .row-poi-diag { display: flex; justify-content: space-between; align-items: flex-end; font-weight: bold; }
        .diag-code { background: black; color: white; padding: 1px 4px; font-size: 9pt; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>Gener√°tor ≈°t√≠tkov (iOS OCR)</h2>

        <label for="cameraInput" class="btn-photo">
            üì∑ Odfoti≈• doklad a naƒç√≠ta≈•
        </label>
        <input type="file" id="cameraInput" accept="image/*" capture="environment">

        <div id="statusMessage">Pripraven√© na fotenie...</div>

        <div class="inputs-grid">
            <input type="text" id="dataSurname" placeholder="PRIEZVISKO" class="full-width">
            <input type="text" id="dataName" placeholder="Meno" class="full-width">
            <input type="text" id="dataRC" placeholder="Rodn√© ƒç√≠slo">
            <input type="text" id="dataPoi" placeholder="Pois≈•ov≈àa">
            <input type="text" id="dataDiag" placeholder="Diagn√≥za">
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center; justify-content: center;">
            <label>Vynecha≈•: <input type="number" id="offsetInput" value="0" style="width: 50px; padding: 5px;"></label>
            <label>Poƒçet: <input type="number" id="countInput" value="10" style="width: 50px; padding: 5px;"></label>
        </div>

        <button onclick="updatePreview()" style="background:#007AFF; color:white; border:none; padding:10px; width:100%; margin-top:10px; border-radius:8px;">üîÑ Aktualizova≈• n√°hƒæad</button>
        <button onclick="window.print()" class="btn-print">üñ®Ô∏è Tlaƒçi≈•</button>
    </div>

    <div class="page-container">
        <div class="label-grid" id="gridContainer"></div>
    </div>

    <script>
        // --- 1. LOGIKA OCR (Rozpozn√°vanie textu) ---
        const cameraInput = document.getElementById('cameraInput');
        const statusMsg = document.getElementById('statusMessage');

        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusMsg.innerHTML = "‚è≥ Spracov√°vam fotku... (cca 5 sek√∫nd)";
            statusMsg.style.color = "#007AFF";

            try {
                // Spustenie Tesseract OCR
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'slk', // Slovenƒçina (alebo 'eng' ak slk blbne)
                    { logger: m => console.log(m) }
                );

                console.log("Naƒç√≠tan√Ω text:", text);
                statusMsg.innerHTML = "‚úÖ √ödaje naƒç√≠tan√©!";
                statusMsg.style.color = "green";

                parseText(text);

            } catch (error) {
                console.error(error);
                statusMsg.innerHTML = "‚ùå Chyba pri ƒç√≠tan√≠. Sk√∫ste znova.";
                statusMsg.style.color = "red";
            }
        });

        // --- 2. INTELIGENTN√â HƒΩADANIE √öDAJOV (Regex) ---
        function parseText(rawText) {
            // Vyƒçistenie textu
            const text = rawText.replace(/\n/g, " ").replace(/\s+/g, " ");

            // A. Hƒæadanie RODN√âHO ƒå√çSLA (form√°t 6 ƒç√≠slic / 3-4 ƒç√≠slice, alebo bez lomky)
            // Hƒæad√°me vzor: RC: cislo alebo len dlh√© ƒç√≠slo
            const rcMatch = text.match(/RC[:\.\s]*(\d{6}\/?\d{3,4})|(\d{6}\/\d{3,4})/i);
            if (rcMatch) {
                let cleanRC = (rcMatch[1] || rcMatch[2]).replace(/\s/g, "");
                document.getElementById('dataRC').value = cleanRC;
            }

            // B. Hƒæadanie POIS≈§OVNE (k√≥d 25xx, 24xx, 27xx)
            // Hƒæad√°me za slovom Poi alebo ID poist
            const poiMatch = text.match(/Poi[:\.\s]*(\d{4})|(\d{4})/i);
            // Jednoduch√° heuristika: Ak n√°jdeme 4-cifern√© ƒç√≠slo zaƒç√≠naj√∫ce na 2
            const simplePoi = text.match(/\b(25\d{2}|24\d{2}|27\d{2})\b/);
            
            if (poiMatch && poiMatch[1]) document.getElementById('dataPoi').value = poiMatch[1];
            else if (simplePoi) document.getElementById('dataPoi').value = simplePoi[0];

            // C. Hƒæadanie DIAGN√ìZY (P√≠smeno + ƒç√≠sla, napr. R06.0, I10)
            const diagMatch = text.match(/\b([A-Z]\d{2,3}(\.\d)?)\b/);
            if (diagMatch) {
                document.getElementById('dataDiag').value = diagMatch[0];
            }

            // D. Hƒæadanie MENA a PRIEZVISKA (Naj≈•a≈æ≈°ie, sk√∫sime odhadn√∫≈•)
            // Priezvisko b√Ωva ƒçasto veƒæk√Ωm p√≠smom (ALL CAPS)
            const words = rawText.split(/[\n\s]+/);
            let surnameFound = "";
            let nameFound = "";

            // Hƒæad√°me slovo, ktor√© je cel√© VEƒΩK√ùM a m√° aspo≈à 3 p√≠smen√° (IMRIAN)
            for (let w of words) {
                if (w.length > 2 && w === w.toUpperCase() && !w.match(/\d/) && w !== "RC:" && w !== "POI:") {
                    surnameFound = w;
                    break;
                }
            }
            if (surnameFound) document.getElementById('dataSurname').value = surnameFound;

            // Meno b√Ωva zvyƒçajne vedƒæa priezviska alebo prv√© slovo s veƒæk√Ωm p√≠smenom
            // Tu to nech√°me na u≈æ√≠vateƒæa alebo sk√∫sime prv√© slovo s veƒæk√Ωm zaƒçiatoƒçn√Ωm
            // Tento krok je v OCR ƒçasto nepresn√Ω, preto je lep≈°ie ak si meno skontroluje u≈æ√≠vateƒæ.
            
            updatePreview();
        }


        // --- 3. GENER√ÅTOR ≈†T√çTKOV (Rovnak√Ω ako predt√Ωm) ---
        function updatePreview() {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = ''; 

            const offset = parseInt(document.getElementById('offsetInput').value) || 0;
            const count = parseInt(document.getElementById('countInput').value) || 1;
            
            const data = {
                surname: document.getElementById('dataSurname').value || "PRIEZVISKO",
                name: document.getElementById('dataName').value || "Meno",
                rc: document.getElementById('dataRC').value || "000000/0000",
                poi: document.getElementById('dataPoi').value || "0000",
                diag: document.getElementById('dataDiag').value || "",
                kvl: "KVL1-KJ"
            };

            for (let i = 0; i < offset; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let i = 0; i < count; i++) {
                const label = document.createElement('div');
                label.className = 'label';
                label.innerHTML = `
                    <div class="row-surname">${data.surname}</div>
                    <div class="row-name-kvl">
                        <span>${data.name}</span>
                        <span style="font-size: 7pt;">${data.kvl}</span>
                    </div>
                    <div class="row-rc">RC: ${data.rc}</div>
                    <div class="row-poi-diag">
                        <span>Poi: ${data.poi}</span>
                        <span class="diag-code">${data.diag}</span>
                    </div>
                `;
                grid.appendChild(label);
            }
        }
        
        // Inicializ√°cia
        window.onload = updatePreview;
    </script>
</body>
</html>
