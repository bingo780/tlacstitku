<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Skener: Windows + Android + iOS</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        #main-container {
            width: 100%; max-width: 900px; margin: 10px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* OVL√ÅDACIA ƒåAS≈§ */
        .card {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; display: inline-block; }

        /* VSTUPY */
        .usb-input {
            width: 100%; padding: 15px; font-size: 18px; border: 3px solid #ccc; border-radius: 8px;
            text-align: center; background: #f9f9f9; box-sizing: border-box;
        }
        .usb-input:focus { border-color: #28a745; background: #fff; outline: none; }

        /* KAMERA */
        #qr-reader { width: 100%; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        
        .btn {
            width: 100%; padding: 12px; font-size: 16px; border: none; border-radius: 6px;
            cursor: pointer; color: white; font-weight: bold; margin-top: 10px;
        }
        .btn-cam { background: #007bff; }
        .btn-stop { background: #dc3545; display: none; }
        .btn-print { background: #28a745; font-size: 18px; padding: 15px; }

        /* FORMUL√ÅR */
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .grid-form input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }

        /* CHYBOV√â HL√Å≈†KY */
        #error-msg { color: red; font-weight: bold; font-size: 14px; margin-top: 5px; display: none; background: #ffe6e6; padding: 10px; border-radius: 5px; }

        /* --- TLAƒå (A4 5x13) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; margin: 0; }
            #main-container { display: none; }
            .page-container { display: block !important; margin: 0 !important; box-shadow: none !important; }
        }

        /* N√ÅHƒΩAD STRANY */
        .page-container {
            width: 210mm; height: 297mm; background: white;
            padding: 10mm; box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            overflow: hidden; margin-bottom: 50px;
            /* Pri mobile skryjeme n√°hƒæad pod seba, pri tlaƒçi sa uk√°≈æe */
            display: block; 
        }

        .label-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(13, 1fr);
            width: 100%; height: 100%;
        }

        .label {
            box-sizing: border-box; padding: 2px 4px;
            font-size: 9pt; display: flex; flex-direction: column;
            justify-content: space-between; overflow: hidden;
        }

        .row-surname { font-weight: 900; text-transform: uppercase; font-size: 11pt; white-space: nowrap; overflow: hidden; }
        .row-name-kvl { display: flex; justify-content: space-between; }
        .row-rc { font-family: 'Courier New', monospace; letter-spacing: -0.5px; font-weight: bold; }
        .row-poi-diag { display: flex; justify-content: space-between; align-items: flex-end; font-weight: bold; }
        .diag-code { background: black; color: white; padding: 1px 4px; font-size: 9pt; }

    </style>
</head>
<body>

<div id="main-container">
    
    <div class="card">
        <h2>1. Naƒç√≠tanie (Windows / Android / iOS)</h2>
        
        <label style="font-weight:bold; display:block; margin-bottom:5px;">A) Windows USB Skener:</label>
        <input type="text" id="usbInput" class="usb-input" placeholder="Klikni sem a p√≠pni k√≥d..." autocomplete="off">
        
        <label style="font-weight:bold; display:block; margin-top:15px; margin-bottom:5px;">B) Kamera (Mobil/Tablet):</label>
        <div id="error-msg"></div>
        <div id="qr-reader"></div>
        <button id="btn-start" class="btn btn-cam" onclick="startCamera()">üì∑ Spusti≈• kameru</button>
        <button id="btn-stop" class="btn btn-stop" onclick="stopCamera()">‚ùå Zavrie≈• kameru</button>
    </div>

    <div class="card">
        <h2>2. √ödaje na ≈°t√≠tok</h2>
        <div class="grid-form">
            <input type="text" id="dataSurname" placeholder="Priezvisko">
            <input type="text" id="dataName" placeholder="Meno">
            <input type="text" id="dataRC" placeholder="Rodn√© ƒç√≠slo">
            <input type="text" id="dataPoi" placeholder="Pois≈•ov≈àa">
            <input type="text" id="dataDiag" placeholder="Diagn√≥za">
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center;">
            <label>Vynecha≈•: <input type="number" id="offsetInput" value="0" style="width:50px"></label>
            <label>Poƒçet: <input type="number" id="countInput" value="10" style="width:50px"></label>
            <button onclick="updatePreview()" style="padding:5px 15px; cursor:pointer;">üîÑ Prekresli≈•</button>
        </div>
    </div>

    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Tlaƒçi≈• (A4)</button>
</div>

<div class="page-container">
    <div class="label-grid" id="gridContainer"></div>
</div>

<script>
    // --- KONFIGUR√ÅCIA ---
    // Oƒçak√°van√Ω form√°t QR: PRIEZVISKO|MENO|RC|POI|DIAGNOZA
    
    function processCode(text) {
        if (!text) return;
        text = text.trim();
        console.log("Spracov√°vam:", text);

        const parts = text.split('|');
        if (parts.length >= 5) {
            document.getElementById('dataSurname').value = parts[0];
            document.getElementById('dataName').value = parts[1];
            document.getElementById('dataRC').value = parts[2];
            document.getElementById('dataPoi').value = parts[3];
            document.getElementById('dataDiag').value = parts[4];
            
            // P√≠pnutie / vizu√°lna odozva
            document.body.style.backgroundColor = "#d4edda";
            setTimeout(() => { document.body.style.backgroundColor = "#eef2f5"; }, 300);
            
            updatePreview();
            return true;
        } else {
            alert("‚ö†Ô∏è Chyba form√°tu!\nOƒçak√°va sa: Priezvisko|Meno|RC|Pois≈•ov≈àa|Diagn√≥za\nNaƒç√≠tan√©: " + text);
            return false;
        }
    }

    // --- A) USB SKENER (Windows) ---
    const usbInput = document.getElementById('usbInput');
    usbInput.focus(); // Hneƒè po naƒç√≠tan√≠ akt√≠vne
    usbInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (processCode(this.value)) {
                this.value = ""; // Vymaza≈• po √∫spechu
            }
        }
    });
    // V≈ædy udr≈æa≈• kurzor v poli ak neklikneme inam (pre plynul√© skenovanie rad za radom)
    document.addEventListener('click', function(e) {
        if (e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON") {
            usbInput.focus();
        }
    });

    // --- B) KAMERA (Mobil) ---
    let html5QrCode;
    
    function startCamera() {
        const errorEl = document.getElementById('error-msg');
        errorEl.style.display = 'none';

        // Kontrola bezpeƒçnosti pre mobily
        if (location.protocol === 'file:' && /Android|iPhone|iPad/i.test(navigator.userAgent)) {
            errorEl.innerHTML = "‚ö†Ô∏è CHYBA: Na mobiloch kamera nefunguje, ak s√∫bor otv√°rate priamo z pam√§te (file://).<br>Mus√≠te tento s√∫bor nahra≈• na web (mus√≠ by≈• HTTPS).";
            errorEl.style.display = 'block';
            return;
        }

        document.getElementById('qr-reader').style.display = "block";
        document.getElementById('btn-start').style.display = "none";
        document.getElementById('btn-stop').style.display = "inline-block";

        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // Preferujeme zadn√∫ kameru (environment)
        html5QrCode.start({ facingMode: "environment" }, config, 
            (decodedText) => {
                // √öspe≈°n√Ω sken
                if(processCode(decodedText)) {
                    stopCamera(); // Zavrie≈• kameru po √∫spechu
                }
            },
            (errorMessage) => {
                // Ignorujeme chyby pri hƒæadan√≠ k√≥du
            }
        ).catch(err => {
            errorEl.innerHTML = "‚ùå Nepodarilo sa spusti≈• kameru: " + err;
            errorEl.style.display = 'block';
            stopCamera();
        });
    }

    function stopCamera() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('qr-reader').style.display = "none";
                document.getElementById('btn-start').style.display = "inline-block";
                document.getElementById('btn-stop').style.display = "none";
            }).catch(err => console.log(err));
        }
    }

    // --- C) PREKRESLENIE ≈†T√çTKOV ---
    function updatePreview() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = ''; 

        const offset = parseInt(document.getElementById('offsetInput').value) || 0;
        const count = parseInt(document.getElementById('countInput').value) || 1;
        
        const data = {
            surname: document.getElementById('dataSurname').value || "PRIEZVISKO",
            name: document.getElementById('dataName').value || "Meno",
            rc: document.getElementById('dataRC').value || "000000/0000",
            poi: document.getElementById('dataPoi').value || "0000",
            diag: document.getElementById('dataDiag').value || "X00.0",
            kvl: "KVL1-KJ"
        };

        // Pr√°zdne bunky
        for (let i = 0; i < offset; i++) {
            grid.appendChild(document.createElement('div'));
        }

        // D√°ta
        for (let i = 0; i < count; i++) {
            const label = document.createElement('div');
            label.className = 'label';
            label.innerHTML = `
                <div class="row-surname">${data.surname}</div>
                <div class="row-name-kvl">
                    <span>${data.name}</span>
                    <span style="font-size: 7pt;">${data.kvl}</span>
                </div>
                <div class="row-rc">RC: ${data.rc}</div>
                <div class="row-poi-diag">
                    <span>Poi: ${data.poi}</span>
                    <span class="diag-code">${data.diag}</span>
                </div>
            `;
            grid.appendChild(label);
        }
    }

    window.onload = updatePreview;
</script>

</body>
</html>
