<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tlaƒç: ≈†t√≠tky | Riadok | Menovka (s Pr√≠jmom)</title>
    
    <style>
        /* --- UI (Obrazovka) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f4f6f8; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        #controls {
            width: 100%; max-width: 850px; margin: 20px; background: white;
            padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e1e4e8;
        }

        h2 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #0056b3; display: inline-block; padding-bottom: 5px; }

        /* Vstupy a grid */
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 15px; }
        input:focus { border-color: #007bff; outline: none; }
        
        /* Nastavenia posunu */
        .settings-box {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center; border: 1px solid #e9ecef;
        }
        .setting-item { display: flex; flex-direction: column; font-size: 13px; font-weight: 600; color: #555; }
        .setting-item input { width: 80px; margin-top: 5px; padding: 5px; }

        /* Tlaƒçidl√° */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        
        .btn-print { background: #28a745; width: 100%; font-size: 18px; margin-top: 20px; padding: 15px; }
        .btn-gray { background: #6c757d; font-size: 13px; }
        .btn-red { background: #dc3545; font-size: 13px; margin-left: auto; }

        /* Z√°lo≈æky */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; margin-top: 20px; }
        .tab-btn { 
            padding: 12px 20px; cursor: pointer; background: none; border: none; font-size: 16px; 
            color: #666; border-bottom: 4px solid transparent; flex: 1; transition: 0.2s;
        }
        .tab-btn.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; background: #f8f9fa; }

        /* --- TLAƒå (A4) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; margin: 0; }
            #controls { display: none; }
            /* Reset pre tlaƒç */
            .print-area { box-shadow: none !important; margin: 0 !important; background: transparent !important; }
            /* Skrytie neakt√≠vnych re≈æimov */
            .view-section { display: none !important; }
            
            /* Zobrazenie akt√≠vneho */
            body.print-labels #view-labels { display: grid !important; }
            body.print-line #view-line { display: block !important; }
            body.print-tag #view-tag { display: block !important; }
            
            /* Nov√° strana */
            .page-break { page-break-after: always; break-after: page; }
        }

        /* Kontajner pre n√°hƒæad */
        .print-area {
            width: 210mm; min-height: 297mm; background: white; margin-bottom: 50px;
            box-shadow: 0 0 20px rgba(0,0,0,0.15); position: relative;
        }

        /* 1. RE≈ΩIM: ≈†T√çTKY */
        #view-labels {
            width: 100%; height: 297mm; padding: 10mm; box-sizing: border-box;
            display: none; 
            grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(13, 1fr);
        }
        .lbl-box { padding: 2px; display: flex; flex-direction: column; justify-content: space-evenly; overflow: hidden; }
        .lbl-sur { font-family: 'Arial Black', sans-serif; font-weight: 900; font-size: 12pt; text-transform: uppercase; line-height: 1; }
        .lbl-row { display: flex; justify-content: space-between; font-size: 10pt; font-family: Arial, sans-serif; }
        .lbl-tech { font-family: 'Courier New', monospace; font-weight: bold; font-size: 11pt; }

        /* 2. RE≈ΩIM: RIADOK (A4 Strany) */
        #view-line { display: none; width: 100%; }
        
        .page-a4-line {
            width: 210mm; height: 297mm; position: relative; 
            overflow: hidden; background: white;
        }
        
        .line-text-element {
            position: absolute;
            white-space: nowrap;
            font-family: 'Times New Roman', serif;
        }

        /* 3. RE≈ΩIM: MENOVKA */
        #view-tag { display: none; width: 100%; height: 297mm; position: relative; box-sizing: border-box; }
        
        .tag-container {
            width: 100%; box-sizing: border-box;
            font-family: 'Times New Roman', serif;
            display: flex; flex-direction: column;
        }
        .tag-surname { text-transform: uppercase; font-weight: bold; margin-bottom: 15px; }
        .tag-row-bottom { display: flex; justify-content: space-between; width: 100%; }

    </style>
</head>
<body>

<div id="controls">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Tlaƒçov√Ω Mana≈æ√©r</h2>
        <div>
            <button onclick="saveToFile()" class="btn btn-gray">‚¨á Ulo≈æi≈• d√°ta</button>
            <button onclick="document.getElementById('imp').click()" class="btn btn-gray">‚¨Ü Naƒç√≠ta≈• d√°ta</button>
            <input type="file" id="imp" style="display:none" onchange="loadFromFile(this)">
        </div>
    </div>

    <div style="background:#eff6ff; border:2px solid #3b82f6; padding:15px; border-radius:8px; margin-top:20px; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; color:#1e40af;">üè• Pr√≠jem pacienta (JIS Bridge)</h3>
            <span id="dbStatus" style="font-weight:bold; color:red; font-size:14px;">üî¥ DB Nepripojen√°</span>
        </div>
        
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button onclick="connectDB()" class="btn" style="background:#2563eb;">üìÇ Pripoji≈• JIS_DB.json</button>
            
            <div style="flex:1; display:flex; gap:10px; justify-content:flex-end; align-items:center;">
                <label style="margin:0; color:#1e40af;">Ulo≈æi≈• na l√¥≈æko:</label>
                <select id="saveSlot" style="padding:8px; border:2px solid #3b82f6; border-radius:5px; font-weight:bold; color:#1e40af;">
                    <option value="0">1</option>
                    <option value="1">2</option>
                    <option value="2">3</option>
                    <option value="3">4</option>
                    <option value="4">5</option>
                </select>
                <button onclick="savePatientToDB()" class="btn" style="background:#16a34a;">üíæ ULO≈ΩI≈§ do syst√©mu</button>
            </div>
        </div>
        <div style="font-size:11px; color:#64748b; margin-top:5px;">
            Tip: Vypl≈àte √∫daje ni≈æ≈°ie, pripojte datab√°zu a kliknite na Ulo≈æi≈•. Pacient sa objav√≠ v Hl√°sen√≠ aj v Dekurzoch.
        </div>
    </div>
    <div style="display:flex; align-items:center; margin-top: 15px;">
        <h3 style="margin:0; flex-grow:1;">√ödaje pacienta:</h3>
        <button onclick="clearData()" class="btn btn-red">üóëÔ∏è Vymaza≈• √∫daje</button>
    </div>

    <div class="input-row">
        <input type="text" id="d_sur" placeholder="PRIEZVISKO" oninput="update()">
        <input type="text" id="d_nam" placeholder="Meno" oninput="update()">
        <input type="text" id="d_rc" placeholder="Rodn√© ƒç√≠slo" oninput="update()">
        <input type="text" id="d_poi" placeholder="Pois≈•ov≈àa" oninput="update()">
        <input type="text" id="d_dia" placeholder="Diagn√≥za (napr. I25.9)" oninput="update()">
        <input type="hidden" id="d_bed" value=""> 
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="setTab('labels')" id="tab-labels">1. ≈†T√çTKY (5x13)</button>
        <button class="tab-btn" onclick="setTab('line')" id="tab-line">2. RIADOK √öDAJOV</button>
        <button class="tab-btn" onclick="setTab('tag')" id="tab-tag">3. MENOVKA (VEƒΩK√Å)</button>
    </div>

    <div class="settings-box" id="settings-panel"></div>

    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è TLAƒåI≈§</button>
</div>

<div class="print-area">
    
    <div id="view-labels" class="view-section"></div>

    <div id="view-line" class="view-section"></div>

    <div id="view-tag" class="view-section">
        <div id="tag-inner" class="tag-container">
            <div id="tag-sur-el" class="tag-surname"></div>
            <div class="tag-row-bottom">
                <span id="tag-nam-el"></span>
                <span id="tag-year-el"></span>
            </div>
        </div>
    </div>

</div>

<script>
    // Konfigur√°cia
    let config = {
        mode: 'labels',
        // ≈†t√≠tky
        lbl_offset: 0,
        lbl_count: 10,
        // Riadok
        line_top: 20,    // mm
        line_left: 20,   // mm
        line_size: 14,   // pt
        line_copies: 1,  // Poƒçet A4 str√°n
        // Menovka
        tag_top: 30,     // mm
        tag_left: 20,    // mm
        tag_size: 72     // pt
    };

    // Init
    window.onload = () => {
        loadLocal();
        setTab('labels');
    };

    function setTab(mode) {
        config.mode = mode;
        
        // UI Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');

        // Zobrazenie
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.getElementById(`view-${mode}`).style.display = (mode === 'labels') ? 'grid' : 'block';

        // Tlaƒçov√° trieda
        document.body.className = `print-${mode}`;

        renderSettings();
        update();
    }

    function renderSettings() {
        const panel = document.getElementById('settings-panel');
        let html = '';

        if (config.mode === 'labels') {
            html += makeInput('Vynecha≈• poz√≠ci√≠', 'lbl_offset', 0);
            html += makeInput('Poƒçet ≈°t√≠tkov', 'lbl_count', 10);
        } 
        else if (config.mode === 'line') {
            html += makeInput('Odsadenie ZHORA (mm)', 'line_top', 20);
            html += makeInput('Odsadenie ZƒΩAVA (mm)', 'line_left', 20);
            html += makeInput('Veƒækos≈• p√≠sma (pt)', 'line_size', 14);
            html += makeInput('Poƒçet str√°n A4', 'line_copies', 1);
        }
        else if (config.mode === 'tag') {
            html += makeInput('Odsadenie ZHORA (mm)', 'tag_top', 30);
            html += makeInput('Okraj ZƒΩAVA/SPRAVA (mm)', 'tag_left', 20);
            html += makeInput('Veƒækos≈• p√≠sma (pt)', 'tag_size', 72);
        }
        panel.innerHTML = html;
    }

    function makeInput(label, key, def) {
        return `
            <div class="setting-item">
                <label>${label}</label>
                <input type="number" value="${config[key] !== undefined ? config[key] : def}" 
                       onchange="updateConfig('${key}', this.value)">
            </div>`;
    }

    function updateConfig(key, val) {
        config[key] = parseInt(val) || 0;
        saveLocal();
        update();
    }

    // VYMAZA≈§ √öDAJE
    function clearData() {
        if(confirm("Naozaj vymaza≈• v≈°etky textov√© polia?")) {
            document.getElementById('d_sur').value = "";
            document.getElementById('d_nam').value = "";
            document.getElementById('d_rc').value = "";
            document.getElementById('d_poi').value = "";
            document.getElementById('d_dia').value = "";
            saveLocal();
            update();
        }
    }

    function update() {
        const data = {
            sur: document.getElementById('d_sur').value || "PRIEZVISKO",
            nam: document.getElementById('d_nam').value || "Meno",
            rc: document.getElementById('d_rc').value || "000000/0000",
            poi: document.getElementById('d_poi').value || "0000",
            dia: document.getElementById('d_dia').value || "I25.9", 
        };
        saveLocal(); 

        // 1. ≈†T√çTKY
        if (config.mode === 'labels') {
            const grid = document.getElementById('view-labels');
            grid.innerHTML = '';
            for(let i=0; i<config.lbl_offset; i++) grid.appendChild(document.createElement('div'));
            for(let i=0; i<config.lbl_count; i++) {
                let el = document.createElement('div');
                el.className = 'lbl-box';
                el.innerHTML = `
                    <div class="lbl-sur">${data.sur}</div>
                    <div class="lbl-row"><span>${data.nam}</span><span style="font-size:8pt">KVL1-KJ</span></div>
                    <div class="lbl-row lbl-tech"><span>RC:${data.rc}</span></div>
                    <div class="lbl-row lbl-tech"><span>Poi:${data.poi}</span><span>${data.dia}</span></div>
                `;
                grid.appendChild(el);
            }
        }

        // 2. RIADOK (Priezvisko Meno [veƒæk√° medzera] RC [veƒæk√° medzera]...)
        if (config.mode === 'line') {
            const container = document.getElementById('view-line');
            container.innerHTML = '';
            
            // Definovanie medzier
            const bigSep = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"; // Veƒæa medzier medzi √∫dajmi
            const oneSpace = " "; // Jedna medzera medzi priezviskom a menom
            
            // Form√°tovanie riadku
            const textHTML = `${data.sur}${oneSpace}${data.nam}${bigSep}${data.rc}${bigSep}${data.poi}${bigSep}${data.dia}`;
            
            for(let i=0; i < config.line_copies; i++) {
                let page = document.createElement('div');
                page.className = 'page-a4-line page-break';
                
                let line = document.createElement('div');
                line.className = 'line-text-element';
                line.style.top = `${config.line_top}mm`;
                line.style.left = `${config.line_left}mm`;
                line.style.fontSize = `${config.line_size}pt`;
                line.innerHTML = textHTML;

                page.appendChild(line);
                container.appendChild(page);
            }
        }

        // 3. MENOVKA
        if (config.mode === 'tag') {
            const inner = document.getElementById('tag-inner');
            let year = "0000";
            if(data.rc.length >= 2) {
                let yy = parseInt(data.rc.substring(0, 2));
                year = (yy <= 26 ? "20" : "19") + (yy < 10 ? "0"+yy : yy);
            }

            inner.style.paddingTop = `${config.tag_top}mm`;
            inner.style.paddingLeft = `${config.tag_left}mm`;
            inner.style.paddingRight = `${config.tag_left}mm`;
            inner.style.fontSize = `${config.tag_size}pt`;

            document.getElementById('tag-sur-el').innerText = data.sur;
            document.getElementById('tag-nam-el').innerText = data.nam;
            document.getElementById('tag-year-el').innerText = year;
        }
    }

    // --- SAVE / LOAD ---
    function saveLocal() {
        const data = {
            sur: document.getElementById('d_sur').value,
            nam: document.getElementById('d_nam').value,
            rc: document.getElementById('d_rc').value,
            poi: document.getElementById('d_poi').value,
            dia: document.getElementById('d_dia').value,
            cfg: config
        };
        localStorage.setItem('medPrintData', JSON.stringify(data));
    }

    function loadLocal() {
        const raw = localStorage.getItem('medPrintData');
        if(raw) {
            const d = JSON.parse(raw);
            document.getElementById('d_sur').value = d.sur || "";
            document.getElementById('d_nam').value = d.nam || "";
            document.getElementById('d_rc').value = d.rc || "";
            document.getElementById('d_poi').value = d.poi || "";
            document.getElementById('d_dia').value = d.dia || "";
            if(d.cfg) config = {...config, ...d.cfg};
        }
    }

    function saveToFile() {
        const raw = localStorage.getItem('medPrintData');
        const blob = new Blob([raw], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'pacient_data.json';
        a.click();
    }

    function loadFromFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            localStorage.setItem('medPrintData', e.target.result);
            loadLocal();
            renderSettings();
            update();
        };
        reader.readAsText(input.files[0]);
    }

    /* ========================================================== */
    /* JIS BRIDGE (PR√çJEM PACIENTA DO S√öBORU)                     */
    /* ========================================================== */
    let fileHandle = null;
    let dbData = { patients: [null,null,null,null,null], updated: "" };

    async function connectDB() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types:[{description:'JIS Datab√°za', accept:{'application/json':['.json']}}]
            });
            await loadDB();
            const stat = document.getElementById("dbStatus");
            stat.innerText = "‚úÖ Pripojen√© k DB";
            stat.style.color = "green";
        } catch(e) { 
            alert("Nepodarilo sa pripoji≈•: " + e.message); 
        }
    }

    async function loadDB() {
        if(!fileHandle) return;
        const file = await fileHandle.getFile();
        const text = await file.text();
        if(text) dbData = JSON.parse(text);
        if(!dbData.patients) dbData.patients = [null,null,null,null,null];
    }

    async function savePatientToDB() {
        if (!fileHandle) { alert("Najprv kliknite na 'üìÇ Pripoji≈• JIS_DB.json'!"); return; }
        
        // 1. Znova naƒç√≠tame DB, aby sme mali ƒçerstv√© d√°ta (ak in√° appka nieƒço zmenila)
        await loadDB();

        // 2. Zozbierame d√°ta z formul√°ra
        const sur = document.getElementById("d_sur").value;
        const nam = document.getElementById("d_nam").value;
        const rc = document.getElementById("d_rc").value;
        const poi = document.getElementById("d_poi").value;
        const dia = document.getElementById("d_dia").value;
        const slot = parseInt(document.getElementById("saveSlot").value); // 0-4

        if (!sur) { alert("Ch√Ωba priezvisko!"); return; }

        // 3. Ulo≈æ√≠me do objektu
        dbData.patients[slot] = {
            slot: slot + 1,
            bed: slot + 1, // Predvolene posteƒæ = slot
            surname: sur,
            name: nam,
            rc: rc,
            insurance: poi,
            icd: dia,
            admitted: new Date().toISOString()
        };
        dbData.updated = new Date().toISOString();

        // 4. Zap√≠≈°eme na disk
        try {
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(dbData, null, 2));
            await writable.close();
            
            // Efekt
            alert(`‚úÖ Pacient ${sur} bol √∫spe≈°ne prijat√Ω na L√¥≈æko ${slot + 1}!`);
        } catch(e) {
            alert("Chyba pri z√°pise: " + e.message);
        }
    }

</script>
</body>
</html>
