<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tlaƒç ≈°t√≠tkov: QR + OCR + USB</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        #main-container {
            width: 100%; max-width: 700px; margin: 15px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* DIZAJN KARIET */
        .card {
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: #1a1a1a; border-bottom: 2px solid #007bff; padding-bottom: 8px; display: inline-block; }
        h3 { margin: 10px 0 5px 0; font-size: 0.95rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }

        /* TLAƒåIDL√Å */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            cursor: pointer; font-size: 16px; font-weight: bold; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 8px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        .btn-qr { background: linear-gradient(135deg, #007bff, #0056b3); }
        .btn-ocr { background: linear-gradient(135deg, #6610f2, #4c0bce); }
        .btn-load { background: #28a745; margin-top: 5px; }
        .btn-print { background: #343a40; font-size: 18px; padding: 16px; margin-top: 20px; }

        /* VSTUPY */
        .input-group { display: flex; gap: 5px; }
        .usb-input {
            flex: 1; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;
            background: #fdfdfd;
        }
        .usb-input:focus { border-color: #007bff; outline: none; }

        /* SKRYT√â INPUTY PRE S√öBORY (iOS fallback) */
        input[type="file"] { display: none; }

        /* STAVOV√â OKNO */
        #status-box {
            margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center;
            display: none; background: #e9ecef; color: #333;
        }

        /* FORMUL√ÅR √öDAJOV */
        .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .full { grid-column: span 2; }
        .grid-form input { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; width: 100%; box-sizing: border-box; }

        /* TLAƒåOV√ù H√ÅROK (A4) */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; margin: 0; }
            #main-container { display: none; }
            .page-container { display: block !important; margin: 0 !important; box-shadow: none !important; }
        }

        .page-container {
            width: 210mm; height: 297mm; background: white;
            padding: 10mm; box-sizing: border-box; display: block;
            box-shadow: 0 0 20px rgba(0,0,0,0.15); margin-bottom: 50px;
        }
        .label-grid { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(13, 1fr); width: 100%; height: 100%; }
        .label { padding: 2px 4px; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; font-family: Arial, sans-serif; font-size: 9pt; }
        
        .row-surname { font-weight: 900; text-transform: uppercase; font-size: 11pt; white-space: nowrap; overflow: hidden; }
        .row-name-kvl { display: flex; justify-content: space-between; }
        .row-rc { font-family: 'Courier New', monospace; letter-spacing: -0.5px; font-weight: bold; }
        .row-poi-diag { display: flex; justify-content: space-between; align-items: flex-end; font-weight: bold; }
        .diag-code { background: black; color: white; padding: 1px 4px; font-size: 9pt; }
    </style>
</head>
<body>

<div id="main-container">
    
    <div class="card">
        <h2>1. Naƒç√≠ta≈• √∫daje</h2>
        <div id="status-box"></div>

        <h3>A) QR K√≥d (R√Ωchle)</h3>
        <label for="file-qr" class="btn btn-qr">üì∑ Skenova≈• / Odfoti≈• QR k√≥d</label>
        <input type="file" id="file-qr" accept="image/*" capture="environment">

        <h3>B) Text z fotky (Pomal≈°ie)</h3>
        <label for="file-ocr" class="btn btn-ocr">üìÑ Odfoti≈• doklad (Preƒç√≠ta≈• text)</label>
        <input type="file" id="file-ocr" accept="image/*" capture="environment">

        <h3>C) Windows USB / Ruƒçne</h3>
        <div class="input-group">
            <input type="text" id="usbInput" class="usb-input" placeholder="Klikni a p√≠pni alebo vlo≈æ text..." autocomplete="off">
            <button class="btn btn-load" onclick="processManualInput()" style="width: auto; margin: 0;">Naƒç√≠ta≈•</button>
        </div>
        <p style="font-size:12px; color:#666; margin-top:5px;">Form√°t QR: Priezvisko|Meno|RC|Pois≈•ov≈àa|Diagn√≥za</p>
    </div>

    <div class="card">
        <h2>2. Kontrola √∫dajov</h2>
        <div class="grid-form">
            <input type="text" id="dataSurname" placeholder="PRIEZVISKO" class="full">
            <input type="text" id="dataName" placeholder="Meno" class="full">
            <input type="text" id="dataRC" placeholder="Rodn√© ƒç√≠slo">
            <input type="text" id="dataPoi" placeholder="Pois≈•ov≈àa">
            <input type="text" id="dataDiag" placeholder="Diagn√≥za">
        </div>

        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; align-items:center;">
            <label>Odsun: <input type="number" id="offsetInput" value="0" style="width:50px; padding:8px; border-radius:6px; border:1px solid #ccc;"></label>
            <label>Poƒçet: <input type="number" id="countInput" value="10" style="width:50px; padding:8px; border-radius:6px; border:1px solid #ccc;"></label>
            <button onclick="updatePreview()" style="padding:8px 15px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer;">üîÑ Prekresli≈•</button>
        </div>
    </div>

    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Tlaƒçi≈• h√°rok</button>
</div>

<div class="page-container">
    <div class="label-grid" id="gridContainer"></div>
</div>

<script>
    // --- POMOCN√â FUNKCIE ---
    const statusBox = document.getElementById('status-box');

    function showStatus(msg, type = 'info') {
        statusBox.style.display = 'block';
        statusBox.innerHTML = msg;
        statusBox.style.backgroundColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d4edda' : '#e2e3e5');
        statusBox.style.color = type === 'error' ? '#721c24' : (type === 'success' ? '#155724' : '#383d41');
    }

    // --- 1. SPRACOVANIE QR K√ìDU (Form√°t s r√∫rou |) ---
    document.getElementById('file-qr').addEventListener('change', e => {
        if (e.target.files.length === 0) return;
        showStatus("‚è≥ Skenujem QR k√≥d...", 'info');
        
        const html5QrCode = new Html5Qrcode("status-box"); // Dummy element
        html5QrCode.scanFile(e.target.files[0], true)
        .then(decodedText => {
            if (decodedText.includes('|')) {
                const parts = decodedText.split('|');
                fillForm(parts[0], parts[1], parts[2], parts[3], parts[4]);
                showStatus("‚úÖ QR k√≥d √∫spe≈°ne naƒç√≠tan√Ω!", 'success');
            } else {
                showStatus("‚ö†Ô∏è QR k√≥d nem√° spr√°vny form√°t (ch√Ωba znak |)", 'error');
            }
        })
        .catch(err => {
            showStatus("‚ùå QR k√≥d sa nena≈°iel. Sk√∫ste ostrej≈°iu fotku.", 'error');
        });
    });

    // --- 2. SPRACOVANIE OCR (Text z dokladu) ---
    document.getElementById('file-ocr').addEventListener('change', async (e) => {
        if (e.target.files.length === 0) return;
        showStatus("‚è≥ ƒå√≠tam text z fotky... (M√¥≈æe to trva≈• 5-10 sek√∫nd)", 'info');

        try {
            const { data: { text } } = await Tesseract.recognize(
                e.target.files[0],
                'slk', // Slovenƒçina
            );
            console.log("OCR Text:", text);
            parseOCRText(text);
            showStatus("‚úÖ Text preƒç√≠tan√Ω. Skontrolujte √∫daje.", 'success');
        } catch (error) {
            console.error(error);
            showStatus("‚ùå Chyba pri ƒç√≠tan√≠ textu.", 'error');
        }
    });

    function parseOCRText(text) {
        // Vyƒçistenie textu
        text = text.replace(/\n/g, " ").replace(/\s+/g, " ");

        // Hƒæadanie √∫dajov cez REGEX
        const rcMatch = text.match(/RC[:\.\s]*(\d{6}\/?\d{3,4})|(\d{6}\/\d{3,4})/i);
        const poiMatch = text.match(/Poi[:\.\s]*(\d{4})|(\d{4})/i) || text.match(/\b(25\d{2}|24\d{2}|27\d{2})\b/);
        const diagMatch = text.match(/\b([A-Z]\d{2,3}(\.\d)?)\b/);
        
        // Pokus o priezvisko (veƒæk√© p√≠smen√°)
        const words = text.split(" ");
        let surname = "";
        for (let w of words) {
            if (w.length > 3 && w === w.toUpperCase() && !w.match(/\d/) && w !== "RC:" && w !== "POI:") {
                surname = w; break;
            }
        }

        let rc = rcMatch ? (rcMatch[1] || rcMatch[2]).replace(/\s/g, "") : "";
        let poi = poiMatch ? (poiMatch[1] || poiMatch[0]) : "";
        let diag = diagMatch ? diagMatch[0] : "";

        fillForm(surname, "", rc, poi, diag);
    }

    // --- 3. MANU√ÅLNE SPRACOVANIE / USB ---
    function processManualInput() {
        const text = document.getElementById('usbInput').value;
        if (!text) return;

        if (text.includes('|')) {
            // Je to form√°t QR k√≥du
            const parts = text.split('|');
            fillForm(parts[0], parts[1], parts[2], parts[3], parts[4]);
            document.getElementById('usbInput').value = ""; // Vyƒçisti≈•
            showStatus("‚úÖ √ödaje naƒç√≠tan√© manu√°lne.", 'success');
        } else {
            showStatus("‚ö†Ô∏è Text neobsahuje oddeƒæovaƒç |. Zadajte form√°t: Priezvisko|Meno...", 'error');
        }
    }
    
    // Enter v inpute spust√≠ naƒç√≠tanie
    document.getElementById('usbInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') processManualInput();
    });

    // --- SPOLOƒåN√â FUNKCIE ---
    function fillForm(surname, name, rc, poi, diag) {
        if(surname) document.getElementById('dataSurname').value = surname;
        if(name) document.getElementById('dataName').value = name;
        if(rc) document.getElementById('dataRC').value = rc;
        if(poi) document.getElementById('dataPoi').value = poi;
        if(diag) document.getElementById('dataDiag').value = diag;
        updatePreview();
    }

    function updatePreview() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = ''; 
        const offset = parseInt(document.getElementById('offsetInput').value) || 0;
        const count = parseInt(document.getElementById('countInput').value) || 1;
        
        const data = {
            surname: document.getElementById('dataSurname').value || "PRIEZVISKO",
            name: document.getElementById('dataName').value || "Meno",
            rc: document.getElementById('dataRC').value || "000000/0000",
            poi: document.getElementById('dataPoi').value || "0000",
            diag: document.getElementById('dataDiag').value || "X00.0",
            kvl: "KVL1-KJ"
        };

        for (let i = 0; i < offset; i++) grid.appendChild(document.createElement('div'));
        for (let i = 0; i < count; i++) {
            const label = document.createElement('div');
            label.className = 'label';
            label.innerHTML = `
                <div class="row-surname">${data.surname}</div>
                <div class="row-name-kvl"><span>${data.name}</span><span style="font-size:7pt;">${data.kvl}</span></div>
                <div class="row-rc">RC: ${data.rc}</div>
                <div class="row-poi-diag"><span>Poi: ${data.poi}</span><span class="diag-code">${data.diag}</span></div>`;
            grid.appendChild(label);
        }
    }
    window.onload = updatePreview;
</script>
</body>
</html>
