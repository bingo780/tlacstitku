<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tlaƒç ≈°t√≠tkov: Vern√° k√≥pia</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        /* Z√ÅKLADN√â NASTAVENIA UI (Net√Ωka sa tlaƒçe) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #eef2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        #main-container { width: 100%; max-width: 700px; margin: 15px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #333; border-bottom: 2px solid #0056b3; display: inline-block; }
        
        /* Tlaƒçidl√° */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; margin-bottom: 8px; font-size: 14px; }
        .btn-qr { background: #007bff; }
        .btn-ocr { background: #6610f2; }
        .btn-print { background: #28a745; font-size: 18px; padding: 15px; margin-top: 20px; }
        .input-group { display: flex; gap: 5px; }
        .usb-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        input[type="file"] { display: none; }
        #status-box { padding: 10px; border-radius: 6px; text-align: center; display: none; margin-bottom: 10px; font-size: 13px; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .full { grid-column: span 2; }
        .grid-form input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* --- TLAƒåOV√ù ≈†T√ùL (A4) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; margin: 0; }
            #main-container { display: none; }
            .page-container { display: block !important; margin: 0 !important; box-shadow: none !important; }
        }

        .page-container {
            width: 210mm; height: 297mm; background: white;
            padding: 10mm; box-sizing: border-box; display: block;
            margin-bottom: 50px; overflow: hidden;
            /* box-shadow: 0 0 10px rgba(0,0,0,0.2); pre n√°hƒæad na PC */
        }

        .label-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(13, 1fr);
            width: 100%; height: 100%;
        }

        /* --- DIZAJN ≈†T√çTKU PODƒΩA FOTKY --- */
        .label {
            box-sizing: border-box;
            padding: 1mm 2mm; /* Minim√°lne okraje vn√∫tri ≈°t√≠tku */
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* Rozlo≈æi≈• riadky rovnomerne */
            overflow: hidden;
            border: 1px solid white; /* Skryt√Ω r√°mƒçek */
        }

        /* 1. Riadok: PRIEZVISKO (Hrub√©, Sans-Serif) */
        .row-surname {
            font-family: 'Arial Black', 'Arial', sans-serif;
            font-weight: 900;
            font-size: 12pt;
            text-transform: uppercase;
            line-height: 1;
            color: #000;
        }

        /* 2. Riadok: Meno a K√≥d (Sans-Serif) */
        .row-name-kvl {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1;
        }

        /* 3. a 4. Riadok: Technick√© √∫daje (P√≠sac√≠ stroj / Courier) */
        .row-tech {
            font-family: 'Courier New', Courier, monospace; /* Toto rob√≠ ten "lek√°rsky" vzhƒæad */
            font-size: 10.5pt; 
            font-weight: 600; /* Polotuƒçn√© pre ƒçitateƒænos≈• */
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            align-items: center;
            line-height: 1;
            margin-top: 1px;
        }

        .diag-box {
            font-weight: bold;
        }

        /* Jemn√© doladenie pre RC */
        .rc-label { font-size: 9pt; margin-right: 5px; }
        .rc-num { font-size: 11pt; letter-spacing: 0.5px; }

    </style>
</head>
<body>

<div id="main-container">
    <div class="card">
        <h2>1. Naƒç√≠ta≈• √∫daje</h2>
        <div id="status-box"></div>

        <label for="file-qr" class="btn btn-qr">üì∑ Skenova≈• QR k√≥d (Odfoti≈•)</label>
        <input type="file" id="file-qr" accept="image/*" capture="environment">

        <label for="file-ocr" class="btn btn-ocr">üìÑ Odfoti≈• doklad (Preƒç√≠ta≈• text)</label>
        <input type="file" id="file-ocr" accept="image/*" capture="environment">

        <div class="input-group" style="margin-top:10px;">
            <input type="text" id="usbInput" class="usb-input" placeholder="Klikni sem pre USB skener..." autocomplete="off">
            <button class="btn btn-qr" onclick="processManualInput()" style="width: auto; margin:0; background:#28a745;">OK</button>
        </div>
        <div style="font-size:11px; color:#666; margin-top:5px;">
            Podporovan√Ω QR form√°t: PRIEZVISKO|Meno|RC|Pois≈•ov≈àa|Diagn√≥za
        </div>
    </div>

    <div class="card">
        <h2>2. Kontrola a Tlaƒç</h2>
        <div class="grid-form">
            <input type="text" id="dataSurname" placeholder="PRIEZVISKO" class="full">
            <input type="text" id="dataName" placeholder="Meno" class="full">
            <input type="text" id="dataRC" placeholder="Rodn√© ƒç√≠slo">
            <input type="text" id="dataPoi" placeholder="Pois≈•ov≈àa">
            <input type="text" id="dataDiag" placeholder="Diagn√≥za">
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; justify-content: center; align-items: center;">
            <label>Odsun: <input type="number" id="offsetInput" value="0" style="width:40px"></label>
            <label>Poƒçet: <input type="number" id="countInput" value="10" style="width:40px"></label>
            <button onclick="updatePreview()" style="padding:5px 10px;">üîÑ</button>
        </div>
    </div>

    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Tlaƒçi≈• ≈°t√≠tky</button>
</div>

<div class="page-container">
    <div class="label-grid" id="gridContainer"></div>
</div>

<script>
    // --- SKRIPT ---
    const statusBox = document.getElementById('status-box');

    function showStatus(msg, color) {
        statusBox.style.display = 'block';
        statusBox.innerText = msg;
        statusBox.style.backgroundColor = color === 'success' ? '#d4edda' : '#f8d7da';
        statusBox.style.color = color === 'success' ? '#155724' : '#721c24';
    }

    // 1. QR SKENER (Zo s√∫boru/fotky)
    document.getElementById('file-qr').addEventListener('change', e => {
        if (!e.target.files.length) return;
        const html5QrCode = new Html5Qrcode("status-box");
        html5QrCode.scanFile(e.target.files[0], true)
        .then(decodedText => {
            if (decodedText.includes('|')) {
                const p = decodedText.split('|');
                fill(p[0], p[1], p[2], p[3], p[4]);
                showStatus("‚úÖ QR naƒç√≠tan√Ω: " + p[0], 'success');
            } else {
                showStatus("‚ö†Ô∏è Zl√Ω form√°t QR k√≥du", 'error');
            }
        }).catch(err => showStatus("‚ùå QR sa nena≈°iel, sk√∫ste lep≈°iu fotku.", 'error'));
    });

    // 2. OCR (Text z fotky)
    document.getElementById('file-ocr').addEventListener('change', async (e) => {
        if (!e.target.files.length) return;
        showStatus("‚è≥ ƒå√≠tam text... ƒçakajte.", 'success');
        try {
            const { data: { text } } = await Tesseract.recognize(e.target.files[0], 'slk');
            parseOCR(text);
            showStatus("‚úÖ Text naƒç√≠tan√Ω.", 'success');
        } catch (err) { showStatus("‚ùå Chyba ƒç√≠tania.", 'error'); }
    });

    function parseOCR(text) {
        text = text.replace(/\n/g, " ").replace(/\s+/g, " ");
        // Regexy pre √∫daje
        const rc = text.match(/RC[:\.\s]*(\d{6}\/?\d{3,4})|(\d{6}\/\d{3,4})/i);
        const poi = text.match(/Poi[:\.\s]*(\d{4})|(\d{4})/i) || text.match(/\b(25\d{2}|24\d{2})\b/);
        const diag = text.match(/\b([A-Z]\d{2,3}(\.\d)?)\b/);
        
        // Priezvisko (veƒæk√© p√≠smen√° > 3 znaky)
        let surname = "";
        text.split(" ").forEach(w => {
            if (w.length > 3 && w === w.toUpperCase() && !w.match(/\d/) && !w.includes("RC") && !w.includes("POI")) surname = w;
        });

        fill(surname, "", 
             rc ? (rc[1]||rc[2]).replace(/\s/g,"") : "", 
             poi ? (poi[1]||poi[0]) : "", 
             diag ? diag[0] : "");
    }

    // 3. USB / Ruƒçne
    function processManualInput() {
        const val = document.getElementById('usbInput').value;
        if (val.includes('|')) {
            const p = val.split('|');
            fill(p[0], p[1], p[2], p[3], p[4]);
            document.getElementById('usbInput').value = "";
        }
    }
    document.getElementById('usbInput').addEventListener('keydown', e => {
        if(e.key === 'Enter') processManualInput();
    });

    function fill(s, n, r, p, d) {
        if(s) document.getElementById('dataSurname').value = s;
        if(n) document.getElementById('dataName').value = n;
        if(r) document.getElementById('dataRC').value = r;
        if(p) document.getElementById('dataPoi').value = p;
        if(d) document.getElementById('dataDiag').value = d;
        updatePreview();
    }

    // PREKRESLENIE ≈†T√çTKOV (Dizajn)
    function updatePreview() {
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = '';
        const offset = parseInt(document.getElementById('offsetInput').value) || 0;
        const count = parseInt(document.getElementById('countInput').value) || 1;
        
        const d = {
            sur: document.getElementById('dataSurname').value || "PRIEZVISKO",
            nam: document.getElementById('dataName').value || "Meno",
            rc: document.getElementById('dataRC').value || "000000/0000",
            poi: document.getElementById('dataPoi').value || "0000",
            diag: document.getElementById('dataDiag').value || "Dg.X",
            kvl: "KVL1-KJ"
        };

        for(let i=0; i<offset; i++) grid.appendChild(document.createElement('div'));
        
        for(let i=0; i<count; i++) {
            const el = document.createElement('div');
            el.className = 'label';
            // HTML ≈°trukt√∫ra presne podƒæa vizu√°lu
            el.innerHTML = `
                <div class="row-surname">${d.sur}</div>
                <div class="row-name-kvl">
                    <span>${d.nam}</span>
                    <span style="font-size: 8pt;">${d.kvl}</span>
                </div>
                <div class="row-tech">
                    <span><span class="rc-label">RC:</span><span class="rc-num">${d.rc}</span></span>
                </div>
                <div class="row-tech">
                    <span>Poi: ${d.poi}</span>
                    <span class="diag-box">${d.diag}</span>
                </div>
            `;
            grid.appendChild(el);
        }
    }
    window.onload = updatePreview;
</script>
</body>
</html>
